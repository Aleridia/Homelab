# Pick upstream based on the SNI hostname (the TLS name the client requests)
limit_conn_zone $binary_remote_addr zone=stream_conn_per_ip:20m;

map $ssl_preread_server_name $selected_upstream {
    badminton-plaisance.<DOMAIN_NAME>  website_local_8443;
    cuisine.<DOMAIN_NAME>             homelab_ingress_443;
    keycloak.<DOMAIN_NAME>            homelab_ingress_443;
    default                       website_local_8443;
}

upstream homelab_ingress_443 {
    # Your ingress entrypoint reachable from the VPS over the VPN
    server <NODE_05>:443;
}

upstream website_local_8443 {
    # Local HTTPS virtual hosts (served by nginx http{} on 8443)
    server 127.0.0.1:8443;
}

server {
    listen 443;

    limit_conn stream_conn_per_ip 40;
    proxy_connect_timeout 5s;
    proxy_timeout 90s;

    proxy_pass $selected_upstream;
    ssl_preread on;
}
