# Pick upstream based on the SNI hostname (the TLS name the client requests).
# Stream context cannot inspect HTTP paths; it only sees TLS metadata and TCP sessions.
limit_conn_zone $binary_remote_addr zone=stream_conn_per_ip:20m;

map $ssl_preread_server_name $sni_class {
    badminton-plaisance.<DOMAIN_NAME>  badminton;
    cuisine.<DOMAIN_NAME>              cuisine;
    keycloak.<DOMAIN_NAME>             keycloak;
    default                            unknown;
}

log_format stream_access
    '$remote_addr [$time_local] '
    'sni="$ssl_preread_server_name" class="$sni_class" '
    'status=$status bytes_in=$bytes_received bytes_out=$bytes_sent '
    'session_time=$session_time upstream="$upstream_addr"';

map $ssl_preread_server_name $selected_upstream {
    badminton-plaisance.<DOMAIN_NAME>  website_local_8443;
    cuisine.<DOMAIN_NAME>             homelab_ingress_443;
    keycloak.<DOMAIN_NAME>            homelab_ingress_443;
    default                       website_local_8443;
}

upstream homelab_ingress_443 {
    # Your ingress entrypoint reachable from the VPS over the VPN
    server <NODE_05>:443;
}

upstream website_local_8443 {
    # Local HTTPS virtual hosts (served by nginx http{} on 8443)
    server 127.0.0.1:8443;
}

server {
    listen 443;

    # Connection limits to reduce DoS/flood impact.
    limit_conn stream_conn_per_ip 30;
    preread_timeout 10s;
    proxy_connect_timeout 3s;
    proxy_timeout 90s;

    proxy_pass $selected_upstream;
    ssl_preread on;

    access_log /var/log/nginx/stream-access.log stream_access;
    error_log /var/log/nginx/stream-error.log warn;
}
